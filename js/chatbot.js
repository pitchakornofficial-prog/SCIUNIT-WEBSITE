(function () {
  const widget = document.getElementById("chatWidget");
  const body = document.getElementById("chatBody");
  const form = document.getElementById("chatForm");
  const input = document.getElementById("chatText");
  const toggle = document.getElementById("chatToggle");
  const suggest = document.getElementById("chatSuggest");

  if (!widget || !body || !form || !input) return;

  // ===== 1) ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) =====
  const knowledge = [
    {
      title: "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏£‡∏£‡∏Ñ",
      keywords: ["‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏£‡∏£‡∏Ñ", "‡∏°‡∏µ‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô", "‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á","‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"],
      answer: "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏° ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ñ‡∏≤‡∏°‡∏ó‡∏≥‡πÑ‡∏°‡πÅ‡∏Ñ‡πà‡πÄ‡∏ô‡∏µ‡πâ‡∏¢!!",
    },
    {
      title: "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏£‡∏Ñ",
      keywords: ["‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏£‡∏Ñ", "‡∏°‡∏∞‡∏≠‡∏∏"],
      answer: "‡∏°‡∏∞‡∏≠‡∏∞‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏‡∏≠‡∏∏ ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤",
    },
    {
      title: "‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à",
      keywords: ["‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à"],
      answer: "‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à",
    },
    {
      title: "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ",
      keywords: [
        "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢",
        "policy",
        "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á",
        "‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£",
        "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
        "‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á",
      ],
      answer:
        "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á SCI UNIT (‡∏™‡∏£‡∏∏‡∏õ):\n" +
        "‚Ä¢ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤\n" +
        "‚Ä¢ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°\n" +
        "‚Ä¢ ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à\n" +
        "‚Ä¢ ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤\n" +
        "‚Ä¢ ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°\n" +
        "‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠\n" +
        "‚Ä¢ ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå",
    },
    {
      title: "‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏£‡∏≤",
      keywords: ["‡∏ó‡∏≥‡πÑ‡∏°", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", "‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å", "why", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏£‡∏≤"],
      answer:
        "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà SCI UNIT ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á:\n" +
        "‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ\n" +
        "‚Ä¢ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏î‡πâ\n" +
        "‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á\n" +
        "‚Ä¢ ‡πÑ‡∏°‡πà‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°\n" +
        "‚Ä¢ ‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    },
    {
      title: "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ",
      keywords: [
        "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠",
        "‡πÇ‡∏ó‡∏£",
        "‡πÄ‡∏ö‡∏≠‡∏£‡πå",
        "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
        "email",
        "facebook",
        "‡πÄ‡∏ü‡∏™",
        "‡πÑ‡∏≠‡∏à‡∏µ",
        "ig",
        "tiktok",
        "tt",
        "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°",
        "‡πÅ‡∏ä‡∏ó",
      ],
      answer:
        "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ & ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° SCI UNIT:\n" +
        "‚Ä¢ ‡πÇ‡∏ó‡∏£: 093-526-2414\n" +
        "‚Ä¢ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: smosci.sciunit@gmail.com\n" +
        "‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: Facebook / Instagram / TikTok (‡∏û‡∏£‡∏£‡∏Ñ SCI UNIT)",
    },
    {
      title: "‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á",
      keywords: [
        "‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á",
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á",
        "‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á",
        "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà",
        "date",
        "‡πÄ‡∏ß‡∏•‡∏≤",
      ],
      answer:
        "‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á: 27 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569\n" + "‡πÄ‡∏ß‡∏•‡∏≤: 09:00 ‡∏ô. - 17:00 ‡∏ô.",
    },
    {
      title: "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏£‡∏£‡∏Ñ",
      keywords: ["‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö", "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå", "‡∏û‡∏±‡∏ô‡∏ò‡∏Å‡∏¥‡∏à", "‡∏ó‡∏µ‡πà‡∏°‡∏≤", "about"],
      answer:
        "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö SCI UNIT:\n" +
        "‚Ä¢ ‡∏û‡∏£‡∏£‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå\n" +
        "‚Ä¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ ‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°\n" +
        "‚Ä¢ ‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô",
    },
  ];

  // ===== 2) ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö =====
  const normalize = (s) =>
    String(s || "")
      .toLowerCase()
      .replace(/\s+/g, " ")
      .trim();

  function scoreMatch(query, item) {
    const q = normalize(query);
    let score = 0;
    for (const kw of item.keywords) {
      const k = normalize(kw);
      if (!k) continue;
      if (q.includes(k)) score += 3; // ‡∏ï‡∏£‡∏á keyword
      else if (k.includes(q) && q.length > 2) score += 1; // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô
    }
    // ‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    if (q.includes(normalize(item.title))) score += 2;
    return score;
  }

  function findBestAnswer(query) {
    let best = null;
    let bestScore = 0;
    for (const item of knowledge) {
      const s = scoreMatch(query, item);
      if (s > bestScore) {
        bestScore = s;
        best = item;
      }
    }
    return { best, bestScore };
  }

  function addBubble(text, who) {
    const div = document.createElement("div");
    div.className = `bubble ${who}`;
    div.textContent = text;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }

  // ===== 3) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö =====
  addBubble(
    "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ SCI UNIT Assistant üôÇ\n‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‚Äù, ‚Äú‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏£‡∏≤‚Äù, ‚Äú‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‚Äù, ‚Äú‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‚Äù",
    "bot"
  );

  // ===== 4) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° =====
  function handleAsk(q) {
    const query = String(q || "").trim();
    if (!query) return;

    addBubble(query, "user");

    const { best, bestScore } = findBestAnswer(query);

    if (!best || bestScore < 2) {
      addBubble(
        "‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üòÖ\n‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‚Äù, ‚Äú‡∏ó‡∏≥‡πÑ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏≤‚Äù, ‚Äú‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‚Äù, ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢",
        "bot"
      );
      return;
    }

    addBubble(best.answer, "bot");
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    handleAsk(input.value);
    input.value = "";
    input.focus();
  });

  // ‡∏ä‡∏¥‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  if (suggest) {
    suggest.addEventListener("click", (e) => {
      const btn = e.target.closest(".chip");
      if (!btn) return;
      handleAsk(btn.getAttribute("data-q"));
    });
  }

  // ‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢
  if (toggle) {
    toggle.addEventListener("click", () => {
      widget.classList.toggle("collapsed");
      toggle.textContent = widget.classList.contains("collapsed") ? "+" : "‚Äî";
    });
  }
})();
